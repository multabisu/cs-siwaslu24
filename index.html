<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CS Siwaslu24</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css"
      rel="stylesheet"
    />
    <script src="/main.js"></script>
  </head>
  <body>
    <div id="app">
      <div class="p-4">
        <div v-if="!isAlreadyLogin">
          <button @click.prevent="loginAdmin">Masuk Dulu Sini brok!</button>
        </div>

        <div v-if="isAlreadyLogin">
          <h1
            class="text-bold text-2xl mb-2 border-b rounded-md p-2 bg-blue-200"
          >
            Cari User <button @click="reset">Reset</button>
          </h1>

          <form @submit.prevent="searchUser()">
            <div class="grid gap-6 mb-6 md:grid-cols-3">
              <div>
                <label
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >ID</label
                >
                <input
                  type="text"
                  v-model="user.id"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                />
              </div>
              <div>
                <label
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >Nama</label
                >
                <input
                  type="text"
                  v-model="user.name"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                />
              </div>
              <div>
                <label
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >Nomor Telepon</label
                >
                <input
                  type="text"
                  v-model="user.phone"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                />
              </div>
            </div>
            <div class="grid gap-6 mb-6 md:grid-cols-4">
              <div>
                <label
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >Provinsi</label
                >
                <input
                  type="text"
                  v-model="user.provinsi"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                />
              </div>
              <div>
                <label
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >Kabupaten/Kota</label
                >
                <input
                  type="text"
                  v-model="user.kab_kota"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                />
              </div>
              <div>
                <label
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >Kecamatan</label
                >
                <input
                  type="text"
                  v-model="user.kecamatan"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                />
              </div>
              <div>
                <label
                  class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                  >Desa/Kelurahan</label
                >
                <input
                  type="text"
                  v-model="user.desa_kel"
                  class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                />
              </div>
            </div>

            <button
              type="submit"
              class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
            >
              Cari
            </button>
            <button
              @click="reset()"
              class="text-blue-700 hover:text-white bg-white ml-2 border border-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm w-full sm:w-auto px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
            >
              Reset
            </button>
          </form>

          <div class="mt-10">
            <h1
              class="text-bold text-2xl mb-2 border-b rounded-md p-2 bg-blue-200"
            >
              Daftar User
            </h1>

            <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
              <table
                class="w-full text-xs text-left rtl:text-right text-gray-500 dark:text-gray-400"
              >
                <thead
                  class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
                >
                  <tr>
                    <th scope="col" class="px-6 py-3">ID</th>
                    <th scope="col" class="px-6 py-3">Nama</th>
                    <th scope="col" class="px-6 py-3">HP</th>
                    <th scope="col" class="px-6 py-3">Level</th>
                    <th scope="col" class="px-6 py-3">Provinsi</th>
                    <th scope="col" class="px-6 py-3">Kab / Kota</th>
                    <th scope="col" class="px-6 py-3">Kecamatan</th>
                    <th scope="col" class="px-6 py-3">Desa / Kel</th>
                    <th scope="col" class="px-6 py-3">TPS</th>
                    <th scope="col" class="px-6 py-3">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    v-for="item in listUser"
                    class="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700"
                  >
                    <th
                      scope="row"
                      class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white"
                    >
                      {{ item.id }}
                    </th>
                    <td class="px-4 py-2">{{ item.name }}</td>
                    <td class="px-4 py-2">{{ item.phone }}</td>
                    <td class="px-4 py-2">{{ item.type }}</td>
                    <td class="px-4 py-2">
                      {{ item.name_provinsi ? item.name_provinsi : "" }}
                    </td>
                    <td class="px-4 py-2">
                      {{ item.name_kab_kota ? item.name_kab_kota : "" }}
                    </td>
                    <td class="px-4 py-2">
                      {{ item.name_kecamatan ? item.name_kecamatan : "" }}
                    </td>
                    <td class="px-4 py-2">
                      {{ item.name_desa_kel ? item.name_desa_kel : "" }}
                    </td>
                    <td class="px-4 py-2">{{ item.tps ? item.tps : "-" }}</td>
                    <td class="px-4 py-2">
                      <button
                        class="bg-blue-500 hover:bg-blue-400 text-white px-4 py-2 rounded-lg"
                        @click="select(item)"
                      >
                        Pilih
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <tr class="text-center w-full">
              Tidak Ada Data
            </tr>
          </div>

          <div v-if="payloadChangeUser.id && !isLoading">
            <h2>Mau di apain nih si {{ selectedUser.name.split(" ")[0] }}?</h2>

            <button>Hapus Semua Formulirnye</button>

            <form @submit.prevent="confirmUpdateUser()">
              <table>
                <tr v-for="(value, key) in selectedUser">
                  <td>{{ key }}</td>

                  <td v-if="key == 'id'">{{ payloadChangeUser.id }}</td>

                  <td v-else-if="key == 'name'">
                    <input v-model="payloadChangeUser.name" />
                  </td>

                  <td v-else-if="key == 'phone'">
                    <input v-model="payloadChangeUser.phone" />
                  </td>

                  <td v-else-if="key == 'tps'">
                    <input
                      v-if="selectedUser.tps"
                      v-model="payloadChangeUser.tps"
                    />
                  </td>

                  <td v-else-if="key == 'name_provinsi'">{{ value }}</td>
                  <td v-else-if="key == 'name_kab_kota'">{{ value }}</td>
                  <td v-else-if="key == 'name_kecamatan'">{{ value }}</td>
                  <td v-else-if="key == 'name_desa_kel'">{{ value }}</td>

                  <td v-else>{{ value ? "Sudah Kirim Formulir" : "Belum" }}</td>
                </tr>
                <tr>
                  <td>Password</td>
                  <td v-if="!isChangePassword">
                    <button @click="isChangePassword = true">
                      Ganti Password?
                    </button>
                  </td>
                  <td v-else>
                    <input v-model="payloadChangeUser.password" />
                    <button
                      v-if="isChangePassword"
                      @click="isChangePassword = false"
                    >
                      Batal
                    </button>
                  </td>
                </tr>
              </table>

              <input type="submit" value="Update" />
            </form>
          </div>
        </div>

        <div v-if="isLoading">
          <h1>- - -> <i>Bentar Yak lagi Loding nih ...!!</i></h1>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref } = Vue;

      createApp({
        setup() {
          const baseUrl = "https://siwaslu2024.bawaslu.go.id/api";
          const isAlreadyLogin = ref(false);
          const isLoading = ref(false);
          const access_token = ref("");
          const user = ref({
            id: null,
            name: "",
            phone: "",
            provinsi: "",
            kab_kota: "",
            kecamatan: "",
            desa_kel: "",
          });
          const listUser = ref([]);
          const selectedUser = ref();
          const isChangePassword = ref(false);
          const payloadChangeUser = ref({
            id: "",
            name: "",
            phone: "",
            tps: 0,
            password: "",
          });

          // LOGIN ADMIN
          const loginAdmin = () => {
            const payload = {
              email: "admin_kode@admin.com",
              password: "admin_kode",
            };

            async function postLoginAdmin() {
              isLoading.value = true;
              const responseLoginAdmin = await fetch(
                baseUrl + "/api/login-admin",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(payload),
                }
              );

              return responseLoginAdmin.json();
            }

            postLoginAdmin().then((x) => {
              if (x.code == 200) {
                isAlreadyLogin.value = true;
                access_token.value = x.data.access_token;
              }

              isLoading.value = false;
            });
          };

          const searchUser = () => {
            selectedUser.value = {
              id: null,
              type: "",
              name: "",
              name_provinsi: "",
              name_kab_kota: "",
              name_kecamatan: "",
              name_desa_kel: "",
              phone: "",
              tps: 0,
              password: "",
            };

            async function postsearchUser() {
              isLoading.value = true;
              const responsesearchUser = await fetch(
                baseUrl +
                  `/api/user?${
                    user.value.name ? "name=" + user.value.name : ""
                  }${user.value.id ? "&id=" + user.value.id : ""}${
                    user.value.phone ? "phone=" + user.value.phone : ""
                  }`,
                {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: access_token.value,
                  },
                }
              );

              return responsesearchUser.json();
            }

            postsearchUser().then((x) => {
              listUser.value = x.data;

              isLoading.value = false;
            });
          };

          const select = (value) => {
            payloadChangeUser.value = {
              id: null,
              name: "",
              phone: "",
              tps: 0,
              password: "",
            };

            async function postselectUser() {
              isLoading.value = true;
              const responseselectUser = await fetch(
                baseUrl + `/api/user/${value.id}?withform=1`,
                {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: access_token.value,
                  },
                }
              );

              return responseselectUser.json();
            }

            postselectUser().then((x) => {
              isLoading.value = false;
              isChangePassword.value = false;

              payloadChangeUser.value = {
                id: x.data.id,
                name: x.data.name,
                phone: x.data.phone,
                tps: x.data.tps,
                password: "",
              };

              selectedUser.value = x.data;
            });
          };

          const reset = () => {
            user.value = {
              id: null,
              name: "",
              phone: "",
            };

            isChangePassword.value = false;

            payloadChangeUser.value = {
              id: null,
              name: "",
              phone: "",
              tps: 0,
              password: "",
            };
            listUser.value = [];
          };

          const updateUser = async () => {
            const payload = {};

            if (selectedUser.value.name !== payloadChangeUser.value.name) {
              payload.name = payloadChangeUser.value.name;
            }

            if (selectedUser.value.phone !== payloadChangeUser.value.phone) {
              payload.phone = payloadChangeUser.value.phone;
            }

            if (selectedUser.value.tps !== payloadChangeUser.value.tps) {
              payload.tps = payloadChangeUser.value.tps;
            }

            if (isChangePassword.value) {
              payload.password = payloadChangeUser.value.password;
            }

            isLoading.value = true;
            await fetch(baseUrl + "/api/cs/user/" + selectedUser.value.id, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: access_token.value,
              },
              body: JSON.stringify(payload),
            })
              .then((response) => {
                isLoading.value = false;
                if (response.ok) {
                  return response.json();
                } else {
                  alert(
                    "Error dari serpernya nih. Coba tanya umar ganteng gih."
                  );
                }
              })
              .then((json) => {
                // all good, token is ready
                alert("Manteb Berhasil nih!!");

                select(selectedUser);
              })
              .catch((error) => {
                isLoading.value = false;
                console.log("error", error);
              });
          };

          const confirmUpdateUser = () => {
            if (confirm("Beneran ini yak mao update data ini orang?")) {
              updateUser();
            }
          };

          return {
            baseUrl,
            isAlreadyLogin,
            isLoading,
            access_token,
            user,
            listUser,
            selectedUser,
            isChangePassword,
            payloadChangeUser,
            loginAdmin,
            searchUser,
            select,
            reset,
            updateUser,
            confirmUpdateUser,
          };
        },
      }).mount("#app");
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>
  </body>
</html>
